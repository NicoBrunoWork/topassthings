  ---- Todas las push por usuario desde una fecha dada (sería la fecha del deploy)
DROP TABLE IF EXISTS
  `meli-marketing.MODELLING.7P_PUSHES_SHOWNS_USER`;
​
​
CREATE TABLE
  `meli-marketing.MODELLING.7P_PUSHES_SHOWNS_USER` OPTIONS( expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 2 DAY) ) AS
SELECT
  notif.CUS_CUST_ID AS cus_cust_id,
  notif.NOT_NOTI_DS_DT AS notification_date,
  CASE
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%DG%' THEN 'DG'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%REC%'
  OR NOT_NOTI_CAMPAIGN_ID LIKE '%CELL-RECHARGE%' THEN 'REC'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%SVS%' OR NOT_NOTI_CAMPAIGN_ID LIKE '%SERVICES%' THEN 'SVS'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%P2P%' THEN 'P2P'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%QR%' THEN 'QR'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%TRA%' OR NOT_NOTI_CAMPAIGN_ID LIKE '%W_TR_%' THEN 'TRA'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%ANTENA%' THEN 'ANTENA_RECHARGE'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%ALL%'
  OR NOT_NOTI_CAMPAIGN_ID LIKE '%WALLET-GENERIC%' THEN 'ALL'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%FUND%' THEN 'FUND'
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%ENC%' THEN 'SURVEY'
  ELSE
  'OTHER'
END
  AS flow,
  CASE
    WHEN NOT_NOTI_CAMPAIGN_ID LIKE '%DESCUENTO' THEN 1
  ELSE
  0
END
  AS descuento,
  NOT_NOTI_CAMPAIGN_ID,
  RANK() OVER (PARTITION BY cus_cust_id ORDER BY NOT_NOTI_DS_DT ASC) AS orden_push
FROM
  `meli-bi-data.WHOWNER.BT_NOTIFICATION_CAMPAIGN` notif
WHERE
  notif.SIT_SITE_ID = 'MLB'
  AND notif.NOT_NOTI_BUSINESS = 'mercadolibre'
  AND notif.NOT_NOTI_DS_DT BETWEEN '2021-01-01'
  AND '2021-01-01' + 10
  AND notif.NOT_NOTI_PATH = 'NOTIFICATION_CAMPAIGN'
  AND notif.NOT_NOTI_EVENT_TYPE_ID = 'shown'
  AND notif.NOT_NOTI_CAMPAIGN_ID IN ('7P-CELL-RECHARGE-TRIGGER-X-VISITS',
    '7P-FUND-TRIGGER-X-VISITS',
    '7P-P2P-TRIGGER-X-VISITS',
    '7P-QR-TRIGGER-X-VISITS',
    '7P-SERVICES-TRIGGER-X-VISITS',
    '7P-SVS-TRIGGER-X-VISITS-VIDEO-CONTENT',
    '7P-WALLET-GENERIC-TRIGGER-X-VISITS',
    'MLB_MP_PUSHML_AO_W_REC_ACT_ALL_7P_DESCUENTO',
    'MLB_MP_PUSHML_AO_W_SVS_ACT_ALL_7P_DESCUENTO',
    'MLB_MP_PUSHML_AO_W_TR_ACT_ALL_7P_DESCUENTO',
    'MLA_MP_PUSHML_AO_W_REC_ACT_ALL_7P_DESCUENTO',
    'MLA_MP_PUSHML_AO_W_SVS_ACT_ALL_7P_DESCUENTO',
    'MLA_MP_PUSHML_AO_W_TR_ACT_ALL_7P_DESCUENTO',
    'MLM_MP_PUSHML_AO_W_REC_ACT_ALL_7P_DESCUENTO',
    'MLM_MP_PUSHML_AO_W_SVS_ACT_ALL_7P_DESCUENTO',
    'MLM_MP_PUSHML_AO_W_TR_ACT_ALL_7P_DESCUENTO')
  AND notif.CUS_CUST_ID IS NOT NULL;
​
​
  --- Ultima push por usuario, con toda la info asociada a esa push:
  select 
  aux.cus_cust_id,
  aux.flow,
  aux.descuento,
  aux.orden_push
  from
(SELECT
  AS VALUE ARRAY_AGG(pushes
  ORDER BY
    orden_push DESC
  LIMIT
    1)[
OFFSET
  (0)]
FROM
  `meli-marketing.MODELLING.7P_PUSHES_SHOWNS_USER` pushes
GROUP BY
  cus_cust_id) aux;
